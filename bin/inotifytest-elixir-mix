#!/bin/sh
#
# Setup: apt-get install inotify-tools
#
# Usage: inotifytest-elixir-mix [ADDITIONAL_ARGUMENTS_FOR_MIX_TEST...]
#
# When *.exs files in or beneath lib/ or test/ are modified, this script runs
# their corresponding test/*test.exs files and prints any errors or failures.
#
# Written in 2014 by Suraj N. Kurapati <https://github.com/sunaku>

inotifywait -rqme close_write --format '%w%f' lib test | while read file; do
  # map the changed file to its corresponding test file
  case "$file" in
    (lib/*.ex|lib/*.exs) test=test${file#lib}
                         test=${test%.*}_test.exs
                         [ -f "$test" ] || continue ;; # file is now mapped
    (test/*test.exs)     test=$file                 ;; # file *is* the test!
    (*)                  continue                   ;; # skip unknown files
  esac

  # show which file changed and which test will be run
  printf '\033[33m%s -> \033[36m%s\033[0m\n' \
    "$(date -r "$file" +'%X')" \
    "$file$(test "$file" != "$test" && echo " -> $test")"

  # run the test, which will print errors and failures
  mix test "$test" "$@"
done
