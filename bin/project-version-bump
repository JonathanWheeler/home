#!/usr/bin/env ruby
#
# Adjusts the current version and release date (gleaned from the
# HISTORY markdown file) in all project files to the given values.
# If DESIRED_DATE is not specified, then the current date is used.
#
# Usage: project-version-bump DESIRED_VERSION [DESIRED_DATE]

desired_version = ARGV.shift or raise ArgumentError, 'version required'
desired_date = ARGV.shift || Time.now.strftime('%F')

history = File.read(Dir['HISTORY{.markdown,.md,}'].first, encoding: 'utf-8').
  scan(/^#* ?Version (.+?) \((.+?)\)/)

if current = history.find {|(v,_)| v != desired_version }
  p current => [desired_version, desired_date]

  def replace source, target
    if target != source
      system "fgrep -lR #{source.inspect} bin lib | "\
        "xargs -r sed -i 's/#{source}/#{target}/g'"
    end
  end

  replace current[0], desired_version
  replace current[1], desired_date
end
